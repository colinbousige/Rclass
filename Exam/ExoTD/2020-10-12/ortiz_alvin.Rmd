---
title : "R Exercises - Religion and babies"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc            : true
        toc_float      : true
        toc_depth      : 4
        highlight      : tango
        number_sections: true
        code_download  : FALSE
---


In these exercises we will see the power of the libraries `ggplot2` and `plotly` to make sense of statistical data. The goal is to reproduce the moving chart that you can see in this video from Hans Rosling -- I invite you to watch his other videos, they are quite enlightning and inspiring:

<div style="max-width:854px"><div style="position:relative;height:0;padding-bottom:56.25%"><iframe src="https://embed.ted.com/talks/hans_rosling_religions_and_babies" width="854" height="480" style="position:absolute;left:0;top:0;width:100%;height:100%" frameborder="0" scrolling="no" allowfullscreen></iframe></div></div>

<br>
<br>

For this, we will need to gather the data:

- From [Gapminder](https://www.gapminder.org/data/), data per country and per year from 1800 to 2018:
    - [The children per woman total fertility](Data_Religion/children_per_woman_total_fertility.csv)
    - [The income per capita](Data_Religion/income_per_person_gdppercapita_ppp_inflation_adjusted.csv)
    - [The total population](Data_Religion/population_total.csv)
- From the [PEW research center](https://www.pewforum.org/2015/04/02/religious-projection-table/2010/percent/all/), data per country:
    + [The religious composition](Data_Religion/religion.csv)

------- 

# Data handling

The first thing to do is to load and regroup all these datasets into a single one.

1. Load the `tidyverse` library and, using `read_csv()`, load the 4 datasets in 4 separate data.frames called `children`, `income`, `pop` and `religion`.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

library(tidyverse)
setwd("C:/Users/AJ Ortiz/Desktop/Nanoscale Engineering/R Practices")
children <- read_csv("children.csv"); children
income <- read_csv("income.csv"); income
pop <- read_csv("pop.csv"); pop
religion <- read_csv("religion.csv"); religion

```
2. To reproduce the chart on the video, we need to determine the dominant religion in each country. In the `religion` dataset, add a column `Religion` that will give the name of the dominant religion for each country. For this, you might want to use this method that returns the name of the column containing the maximum of each row of a `data.frame`:

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
DF <- data.frame(V1=c(2,8,1),V2=c(7,3,5),V3=c(9,6,4))
DF
colnames(DF)[max.col(DF)]

religion
religion <- data.frame(religion)
religion$Religion <- colnames(religion[7:14])[max.col(religion[7:14], ties.method = "first")]
religion

```

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

```

3. Using `pivot_longer()`, make all datasets tidy. 

- `children` should now contain 3 columns: `Country`, `Year` and `Fertility`. 
- `income` should now contain 3 columns: `Country`, `Year` and `Income`. 
- `pop` should now contain 3 columns: `Country`, `Year` and `Population`. 

We will only consider data from 1800 to 2018. Example of syntax using the pipe operator `%>%`:

```{r}
DF <- read_table("name  2010  2011  2012  2014
Kevin  10    11   12   123
Jane   122   56   23   4
"
)
DF
DF %>% 
    select(name, '2010':'2012') %>% 
    pivot_longer(col=-name,
                 names_to="Year", 
                 values_to="Score",
                 names_transform=list(Year = as.numeric))

library(tidyverse)

data.frame(read.csv("children_per_woman_total_fertility.csv")) 
childrendat <- children %>% select(Country, "1800":"2018") %>% pivot_longer(col = -Country, names_to = "Year", values_to = "Fertility", names_transform = list(Year = as.numeric))
childrendat

data.frame(read_csv("income_per_person_gdppercapita_ppp_inflation_adjusted.csv"))
incomedat <- income %>% select(Country, "1800":"2018") %>% pivot_longer(col = -Country, names_to = "Year", values_to = "Income", names_transform = list(Year = as.numeric))
incomedat

data.frame(read_csv("population_total.csv"))
popdat <- pop %>% select(Country, "1800":"2018") %>% pivot_longer(col = -Country, names_to = "Year", values_to = "Population", names_transform = list(Year = as.numeric))
popdat

```
The line `names_transform=list(Year = as.numeric)` is here to convert the character year values to numerical values.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

```

4. Now we want to combine all these datasets into a single one called `dat`, containing the columns `Country`, `Year`, `Population`, `Religion`, `Fertility` and `Income`. Look into the `inner_join()` function of the `dplyr` library (which is part of the `tidyverse` library). For the `religion` dataset, we will consider that the proportions of 2010 are representative of all times.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

library(tidyverse)

religiondat <- religion %>% select("Country","Year","Religion")
religiondat

childrendat
incomedat
popdat
dat1 <- inner_join(childrendat, incomedat, by=c("Country","Year"))
dat1
memory.size()
memory.limit()
memory.limit(size = 56000)
dat2 <- inner_join(dat1, popdat, by=c("Country","Year"))
dat2
dat <- inner_join(dat2, religiondat, by=c("Country"))
dat

```

Now our dataset is ready, let's plot it.

# Plotting

1. Load the library `ggplot2` and set the global theme to `theme_bw()` using `theme_set()`

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

library(ggplot2)
theme_set(theme_bw())

```

2. Create a subset of `dat` concerning your origin country. For me it will be `dat_france`

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

dat_Philippines <- subset(dat2, Country=="Philippines")
dat_Philippines

```

3. Plot the evolution of the income per capita and the number of children per woman as a function of the years, and make it look like that (notice the kinks during the two world wars):

```{r echo=TRUE, warning = FALSE, message=FALSE, cache=FALSE}


Phil <- ggplot(data=dat_Philippines, aes(x=Year,y=Income)) + 
    labs(x='Year',y='Household income per capita per year [constant $]', title = "Household Income in the Philippines")
Phil + geom_rect(aes(xmin = 1914, xmax = 1918, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_rect(aes(xmin = 1939, xmax = 1945, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_point(size = 5, alpha = 0.2) + geom_smooth(size = 1.5)

PhilFer <- ggplot(data=dat_Philippines, aes(x=Year,y=Fertility)) + labs(x='Year',y='Children per Woman', title = "Fertility in the Philippines")
PhilFer + geom_rect(aes(xmin = 1914, xmax = 1918, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_rect(aes(xmin = 1939, xmax = 1945, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_line(size = 2, color = "red")

```

4. Create a subset of `dat` containing the data for your country plus all the neighbor countries (if you come from an island, the nearest countries...). For me, `dat_france_region` will contain data from France, Spain, Italy, Switzerland, Germany, Luxembourg and Belgium.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
dat2

dat_SEA <- subset(dat2, Country==c("Philippines","Indonesia","Thailand","Vietnam","Singapore","Malaysia","Cambodia","Myanmar","Laos","Brunei","Timor-Leste"))
dat_SEA

```

5. Plot again income and fertility as a function of the years, but add a color corresponding to the country and a point size to its population:

```{r echo=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

SEA <- ggplot(data=dat_SEA, aes(x=Year,y=Income)) + 
    labs(x='Year',y='Household income per capita per year [constant $]', title = "Household Income in SouthEast Asia")
SEA + geom_rect(aes(xmin = 1914, xmax = 1918, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_rect(aes(xmin = 1939, xmax = 1945, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_point(alpha = 0.5, aes(col=Country,size=Population))

SEAFer <- ggplot(data=dat_SEA, aes(x=Year,y=Fertility)) + labs(x='Year',y='Children per Woman', title = "Fertility in SouthEast Asia")
SEAFer + geom_rect(aes(xmin = 1914, xmax = 1918, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_rect(aes(xmin = 1939, xmax = 1945, ymin = -Inf, ymax = +Inf), fill = "grey", alpha = 0.03) + geom_point(alpha = 0.5, aes(col=Country,size=Population))

```

6. Load the library `plotly` and make the previous graphs interactive. You can make an interactive graph by calling `ggplotly()`, like that:

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

library(plotly)

Phil01 <- data.frame(dat_Philippines)
Phil01 <- ggplot(Phil01, aes(x=Year, y=Income)) + labs(x='Year',y='Household income per capita per year [constant $]', title = "Household Income in the Philippines") + geom_point()
ggplotly(Phil01, dynamicTicks = TRUE)

SEA01 <- data.frame(dat_SEA)
SEA01 <- ggplot(SEA01, aes(x=Year,y=Income)) + labs(x='Year',y='Household income per capita per year [constant $]', title = "Household Income in SouthEast Asia") + geom_point(alpha = 0.5, aes(col=Country,size=Population))
ggplotly(SEA01, dynamicTicks = TRUE)

```

7. Finally, you can add a slider to the interactive graph allowing selecting a value for another variable (just like in the video) by adding the keyword `frame =` in the chart's aesthetics. So now, make the graph of the video ! (you can also add the aesthetics `id=Country` to show the country name in the popup when hovering on a point).


```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
dat_Philippines
dat_SEA

Phil01 <- ggplot(dat_Philippines, aes(x=Population, y=Income))+ labs(x='Population',y='Household income per capita per year [constant $]', title = "Household Income in the Philippines") + geom_point(alpha = 0.5, aes(frame = Year))
ggplotly(Phil01)

SEA01 <- ggplot(dat_SEA, aes(x = Population,y = Income)) + labs(x='Population',y='Household income per capita per year [constant $]', title = "Household Income in SouthEast Asia") + geom_point(alpha = 0.5, aes(col=Country, frame=Year, size = Population, id=Country))
ggplotly(SEA01)

SEA02 <- ggplot(dat_SEA, aes(x = Year, y = Fertility)) + labs(x='Year',y='Children per Woman', title = "Fertility in SouthEast Asia") + geom_point(alpha = 0.5, aes(col=Country, size = Population, frame=Year, id=Year, id=Country))
ggplotly(SEA02)

```
