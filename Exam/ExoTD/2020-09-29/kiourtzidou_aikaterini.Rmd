---
title : "R Exercises - TGA data"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc_depth      : 4
        highlight      : tango
        number_sections: true
        code_download  : FALSE
---

- Load the `tidyverse` package
- Download the TGA data file <a href="Data/ATG.txt" download target="_blank">ATG.txt</a>
- Load it into a `tibble`.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
z <- tibble(read.table("ATG.txt", skip=10, comment.char ="[",header=TRUE, nrow=4088 ) )
```

- Plot the mass (column `Value`) as a function of the temperature `Tr` (Temperature Read) with lines, using `ggplot2`
    + Remove data from the temperature decrease
    + Define nice axis labels with the units
    + Convert degrees Celsius to Kelvins

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
library(ggplot2)
library(tidyverse)

z <- z[-(3714:4100),]
z <- z[-(1:613),]

z$Temp_K <- z$Tr[]+273.15
z

pl <- z %>%
    ggplot(aes(x=Temp_K,y=Value)) +
    labs(x="",y="Mass [mg]") + geom_vline(xintercept = 630.40,linetype="dashed") + theme(axis.text.x=element_blank()) 
pl + geom_line() 





```


- Write a function returning the derivative $\partial y/\partial x$ given two vectors x and y

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
a <- c(runif(10,1,10))  
b <- c(runif(10,2,20))
i <- 1:length(a)

der <- function(x,y) {
  tibble(x=x, y=y, Der_x = x[i+1]-x[i],Der_y = y[i+1]-y[i],Dyx= Der_y/Der_x)
}
  der(a,b)


```


- Add the temperature derivative of the mass reading in a red dashed line in a panel below the previous graph
    + Zoom on the data to see the variations
    + Remove the x label of the top panel and have the same x axis for both panels
    + Try to reproduce the following graph:

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}

library(patchwork)
i <- 1:length(z$Value)
Dyx <- der(z$Temp_K,z$Value)

dplot <- Dyx %>% 
    ggplot(aes(x=z$Temp_K,y=Dyx, color = "red")) +
    labs(x="T[K]",y="Derivative") + ylim(-0.15,0.05) + theme(legend.position = "none") 

dplot + geom_line() + geom_vline(xintercept = 630.40,linetype="dashed") 

(pl + geom_line() + geom_vline(xintercept = 630.40,linetype="dashed") + theme(axis.text.x=element_blank()))/(dplot + geom_line() + geom_vline(xintercept = 630.40,linetype="dashed"))


```
