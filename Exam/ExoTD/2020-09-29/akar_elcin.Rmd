---
title : "R Exercises - TGA data"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc_depth      : 4
        highlight      : tango
        number_sections: true
        code_download  : FALSE
---

- Load the `tidyverse` package
- Download the TGA data file <a href="Data/ATG.txt" download target="_blank">ATG.txt</a>
- Load it into a `tibble`.

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(patchwork)
library(cowplot)
library(egg)
# setwd("/home/marc/Documents/Elcin_folder/Data")
df2 <- read.table("Data/ATG.txt",
                  header = FALSE,
                  skip = 12,
                  nrows = 3701, #The values which temperature starts to decrease are eliminated.
                  col.names = c("Index", "t", "Ts", "Tr", "Value")
                  )
df2 <- tibble(df2)
df2
```

- Plot the mass (column `Value`) as a function of the temperature `Tr` (Temperature Read) with lines, using `ggplot2`
    + Remove data from the temperature decrease
    + Define nice axis labels with the units
    + Convert degrees Celsius to Kelvins

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
#Kelvin column is added into the dataframe df2.
df2 <- mutate(df2, Kelvin = Tr + 273)
colnames(df2)[5] <- "Mass" 

#df3 is a copy of df2 to not change the raw dataframe.
df3 <- df2
df3 <- df3[which(df3$Kelvin>298), ]

P1 <- df3 %>% 
  ggplot(aes(x=Kelvin, y=Mass)) + 
        geom_line(linetype="solid",size=0.2) + 
        labs(x="T [K]", y="Mass [mg]") +
        theme_light() +
        theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
        theme(axis.ticks = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA, size=0.3)) +
        scale_x_continuous(breaks = seq(300, 1100,100))
        
P1
```


- Write a function returning the derivative $\partial y/\partial x$ given two vectors x and y

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
getderivative <- function(x,y){
  a <- diff(y)/diff(x)
  a
}
```


- Add the temperature derivative of the mass reading in a red dashed line in a panel below the previous graph
    + Zoom on the data to see the variations
    + Remove the x label of the top panel and have the same x axis for both panels
    + Try to reproduce the following graph:

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
Deriv <- getderivative(df3[["Kelvin"]], df3[["Mass"]])
Deriv <- tibble(Deriv)
#df4 <- df3
#1 row is removed to get the same lenght as derivative.
df3 <- df3[-1,]
df3 <- mutate(df3, Deriv)
#To get the minimum value for derivative corresponding Kelvin.
peakderiv <- df3[which.min(df3$Deriv),]


P2 <- df3 %>% 
    ggplot(aes(x=Kelvin, y=Deriv)) + 
        geom_line(linetype="dashed",color="red", size=0.5) + 
        labs(x="T [K]", y="Derivative") +
        theme_light() +
        ylim(-0.15, 0.05) +
        theme(axis.ticks = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA, size=0.3)) +
        scale_x_continuous(breaks = seq(300, 1100,100)) +
        geom_vline(xintercept = peakderiv$Kelvin, linetype="dashed", size=.3)

P3 <- P1 + geom_vline(xintercept = peakderiv$Kelvin, linetype="dashed", size=.3)


#2 different ways to plot the graphs together.             
#cowplot::plot_grid(P3, P2, align = "v", ncol = 1, rel_heights = c(0.75, 0.25))
egg::ggarrange(P3, P2, heights = c(0.75, 0.25))

```
